---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: OpenStackCluster
metadata:
  name: {{ .Values.global.clusterName }}
  namespace: default
spec:
  bastion:
    enabled: {{ .Values.bastion.enabled | default "false" }}
    spec:
      flavor: {{ .Values.bastion.flavor }}
      image:
        filter:
          name: {{ .Values.bastion.image }}
      sshKeyName: {{ .Values.sshkeyname }}
      ports:
        - network:
            filter:
              name: {{ .Values.bastion.network }}
          {{- if .Values.bastion.fixedIP }}
          fixedIPs:
            - subnet:
                filter:
                  name: {{ .Values.bastion.subnet | default "tooling" }}
              ipAddress: {{ .Values.bastion.fixedIP }}
          {{- end }}
  disableExternalNetwork: true
  disableAPIServerFloatingIP: true
  network:
    filter:
      name: {{ .Values.controlplane.network }}
  apiServerFixedIP: {{ .Values.controlplane.apiServerFixedIP }}
  controlPlaneAvailabilityZones:
  {{- range .Values.controlplane.availabilityZones }}
  - {{ . }}
  {{- end }}
  identityRef:
    cloudName: openstack
    name: {{ .Values.global.clusterName }}-cloud-config
  managedSecurityGroups:
    # DEBUG: security group inside cluster explicitly disabled
    allowAllInClusterTraffic: true
    allNodesSecurityGroupRules:
      - description: Created by cluster-api-provider-openstack - Cilium (vxlan)
        direction: ingress
        etherType: IPv4
        name: Cilium (vxlan)
        portRangeMax: 8472
        portRangeMin: 8472
        protocol: udp
        remoteManagedGroups:
          - controlplane
          - worker
      - description: Created by cluster-api-provider-openstack - Cilium (health)
        direction: ingress
        etherType: IPv4
        name: Cilium (health)
        portRangeMax: 4240
        portRangeMin: 4240
        protocol: tcp
        remoteManagedGroups:
          - controlplane
          - worker
      - description: Created by cluster-api-provider-openstack - Cilium (hubble)
        direction: ingress
        etherType: IPv4
        name: Cilium (hubble)
        portRangeMax: 4244
        portRangeMin: 4244
        protocol: tcp
        remoteManagedGroups:
          - controlplane
          - worker
      - description: Created by cluster-api-provider-openstack - http to worker node (http)
        remoteIPPrefix: 0.0.0.0/0
        direction: ingress
        etherType: IPv4
        name: http port
        portRangeMin: 80
        portRangeMax: 80
        protocol: tcp
      - description: Created by cluster-api-provider-openstack - https to worker node (https)
        remoteIPPrefix: 0.0.0.0/0
        direction: ingress
        etherType: IPv4
        name: https port
        portRangeMin: 443
        portRangeMax: 443
        protocol: tcp
